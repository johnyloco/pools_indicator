//@version=5
indicator("Liquidity Square - Weekly Aggregated", overlay=true, max_boxes_count=500, max_lines_count=500)

// --- 1. SETTINGS ---
showSquare = input.bool(true, "Show Boxes", group="Main Settings")
showFib    = input.bool(true, "Show Fib Zones", group="Main Settings")
showStats  = input.bool(true, "Show Stats", group="Main Settings")

// --- 2. DATA CALCULATION ---
isNewWeek = ta.change(time("W")) != 0

// Previous week Data
pdHigh  = request.security(syminfo.tickerid, "W", high[1], lookahead=barmerge.lookahead_on)
pdLow   = request.security(syminfo.tickerid, "W", low[1], lookahead=barmerge.lookahead_on)
pdOpen  = request.security(syminfo.tickerid, "W", open[1], lookahead=barmerge.lookahead_on)
pdClose = request.security(syminfo.tickerid, "W", close[1], lookahead=barmerge.lookahead_on)

// Calculate Percentages for the completed previous week
pdBodyMove   = ((pdClose - pdOpen) / pdOpen) * 100
pdTotalRange = ((pdHigh - pdLow) / pdLow) * 100
rangeDiffPrev = pdHigh - pdLow

// Current week Data (Projection)
currHigh = request.security(syminfo.tickerid, "W", high, lookahead=barmerge.lookahead_on)
currLow  = request.security(syminfo.tickerid, "W", low, lookahead=barmerge.lookahead_on)
rangeDiffCurr = currHigh - currLow

// --- 3. PERSISTENT HANDLES ---
var box nextBox = na
var line nextLine = na
var box nextZ1 = na
var box nextZ2 = na

// --- 4. DRAWING LOGIC: HISTORICAL ---
if isNewWeek and showSquare
    int startTime = time
    int endTime   = time_close("W") 
    
    // Levels
    float l236 = pdLow + (rangeDiffPrev * 0.236)
    float l50  = pdLow + (rangeDiffPrev * 0.50)
    float l618 = pdLow + (rangeDiffPrev * 0.618)
    float l78  = pdLow + (rangeDiffPrev * 0.78)

    // 1. Create the box and store it in a local variable
    box liqSquare = box.new(startTime, pdHigh, endTime, pdLow, 
                     xloc=xloc.bar_time, 
                     border_color=color.new(color.gray, 50), 
                     bgcolor=color.new(color.blue, 95))
    
    // 2. Apply Text inside the same block
    if showStats
        string txt = "(O/C): " + str.tostring(pdBodyMove, "#.##") + "% - "
        txt += "(L/H): " + str.tostring(pdTotalRange, "#.##") + "%"
        box.set_text(liqSquare, txt)
        box.set_text_color(liqSquare, color.gray)
        box.set_text_size(liqSquare, size.small)
        box.set_text_valign(liqSquare, text.align_bottom)

    if showFib
        line.new(startTime, l236, endTime, l236, xloc=xloc.bar_time, color=color.orange, width=2)
        box.new(startTime, l618, endTime, l50, xloc=xloc.bar_time, border_color=na, bgcolor=color.new(#f5f76c, 80))
        box.new(startTime, pdHigh, endTime, l78, xloc=xloc.bar_time, border_color=na, bgcolor=color.new(color.red, 80))

// --- 5. DRAWING LOGIC: PROJECTION ---
if showSquare and barstate.islast
    int nextStart = time_close("W")
    int nextEnd   = nextStart + 604800000
    
    if na(nextBox)
        nextBox := box.new(nextStart, currHigh, nextEnd, currLow, xloc=xloc.bar_time, border_color=na, bgcolor=color.new(color.blue, 100))
    else
        box.set_lefttop(nextBox, nextStart, currHigh)
        box.set_rightbottom(nextBox, nextEnd, currLow)

    if showFib
        float nl236 = currLow + (rangeDiffCurr * 0.236)
        float nl50  = currLow + (rangeDiffCurr * 0.50)
        float nl618 = currLow + (rangeDiffCurr * 0.618)
        float nl78  = currLow + (rangeDiffCurr * 0.78)
        
        if na(nextLine)
            nextLine := line.new(nextStart, nl236, nextEnd, nl236, xloc=xloc.bar_time, color=color.orange, width=2)
            nextZ1   := box.new(nextStart, nl618, nextEnd, nl50, xloc=xloc.bar_time, border_color=na, bgcolor=color.new(#f5f76c, 80))
            nextZ2   := box.new(nextStart, currHigh, nextEnd, nl78, xloc=xloc.bar_time, border_color=na, bgcolor=color.new(color.red, 80))
        else
            line.set_xy1(nextLine, nextStart, nl236)
            line.set_xy2(nextLine, nextEnd, nl236)
            box.set_lefttop(nextZ1, nextStart, nl618)
            box.set_rightbottom(nextZ1, nextEnd, nl50)
            box.set_lefttop(nextZ2, nextStart, currHigh)
            box.set_rightbottom(nextZ2, nextEnd, nl78)
