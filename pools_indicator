//@version=5
indicator("Liquidity Square Fixed - Fib & Volume", overlay=true)

// --- 1. SETTINGS ---
showSquare = input.bool(true, "Show Liquidity Square", group="Main Settings")
showFib    = input.bool(true, "Show Fib Zones", group="Main Settings")

// --- 2. DATA & VOLUME CALCULATION ---
isNewDay = ta.change(time("D")) != 0

// Previous Day Data
pdHigh = request.security(syminfo.tickerid, "D", high[1], lookahead=barmerge.lookahead_on)
pdLow  = request.security(syminfo.tickerid, "D", low[1], lookahead=barmerge.lookahead_on)
pdVol  = request.security(syminfo.tickerid, "D", volume[1], lookahead=barmerge.lookahead_on)

// Cumulative Volume for Today
var float currentDayVol = 0.0
if isNewDay
    currentDayVol := volume
else
    currentDayVol += volume

// Volume Percentage calculation
volPercent = (currentDayVol / pdVol) * 100
rangeDiff  = pdHigh - pdLow

// --- 3. OBJECT HANDLES ---
var box liqSquare  = na
var line orange236 = na
var box zone50_61  = na
var box zone71_1   = na

// --- 4. DRAWING LOGIC ---
if isNewDay and showSquare
    int startTime = time
    int endTime   = time + 86400000 
    
    // Level Calculations
    float lev236 = pdLow  + (rangeDiff * 0.236)
    float lev50  = pdLow  + (rangeDiff * 0.50)
    float lev618 = pdLow  + (rangeDiff * 0.618)
    float lev71  = pdLow  + (rangeDiff * 0.71)
    float lev100 = pdHigh

    // Main Square
    liqSquare := box.new(startTime, pdHigh, endTime, pdLow, xloc=xloc.bar_time, 
                 border_color=color.new(color.gray, 50), 
                 bgcolor=color.new(color.blue, 95),
                 text_size=size.small, text_color=color.white, text_valign=text.align_bottom)

    if showFib
        // Level 0.236: Orange Line
        orange236 := line.new(startTime, lev236, endTime, lev236, xloc=xloc.bar_time, 
                     color=color.orange, style=line.style_dashed, width=2)

        // Zone 1: 0.5 to 0.618 (Yellow)
        zone50_61 := box.new(startTime, lev618, endTime, lev50, xloc=xloc.bar_time, 
                     border_color=na, bgcolor=color.new(color.yellow, 85))

        // Zone 2: 0.71 to 1.0 (Red)
        zone71_1  := box.new(startTime, lev100, endTime, lev71, xloc=xloc.bar_time, 
                     border_color=na, bgcolor=color.new(color.red, 85))

// --- 5. REAL-TIME VOLUME UPDATE ---
if not na(liqSquare) and showSquare
    box.set_text(liqSquare, "Vol: " + str.tostring(volPercent, "#.##") + "%")

// --- 6. CLEANUP ON TOGGLE ---
if not showSquare
    box.delete(liqSquare)
    line.delete(orange236)
    box.delete(zone50_61)
    box.delete(zone71_1)
